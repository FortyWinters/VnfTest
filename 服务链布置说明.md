#### Network

设置端口组要设置不同的VLAN ID	

|          |                       |                       |              |
| -------- | --------------------- | --------------------- | ------------ |
| client   | 192.168.1.10（sfc_1） | /                     | 192.168.1.20 |
| iptables | 192.168.1.20（sfc_1） | 192.168.2.20（sfc_2） | 192.168.2.30 |
| Suricata | 192.168.2.30（sfc_2） | 192.168.3.30（sfc_3） | 192.168.3.40 |
| ntopng   | 192.168.3.40（sfc_3） | 192.168.4.40（sfc_4） | 192.168.4.50 |
| nDPI     | 192.168.4.50（sfc_4） | 192.168.5.50（sfc_5） | 192.168.5.60 |
| HAproxy  | 192.168.5.60（sfc_5） | 192.168.6.60（sfc_6） | 192.168.6.70 |
| server   | 192.168.6.70（sfc_6） | 10.112.103.37         | /            |

`# vim /etc/network/interfaces`

```
auto lo
iface lo inet loopback

auto ens160
iface ens160 inet static
address ens160_ip
netmask 255.255.255.0
gateway gateway_ip
#dns-nameservers 223.5.5.5
```

`# systemctl restart networking`



#### 时钟同步

##### client节点

`# apt install ntp ntpdate ntpstats` 

`# vim /etc/ntp.conf`

```
#pool 0.ubuntu.pool.ntp.org iburst
#pool 1.ubuntu.pool.ntp.org iburst
#pool 2.ubuntu.pool.ntp.org iburst
#pool 3.ubuntu.pool.ntp.org iburst
#pool ntp.ubuntu.com

restrict 192.168.1.10 mask 255.255.255.0 nomodify
server 127.127.1.0
fudge 127.127.1.0 stratum 10
```

`# service ntp restart`



##### 其他节点

`# apt install ntp ntpdate`

`# vim /etc/ntp.conf`

```
server 192.168.1.10 prefer
#pool 0.ubuntu.pool.ntp.org iburst
#pool 1.ubuntu.pool.ntp.org iburst
#pool 2.ubuntu.pool.ntp.org iburst
#pool 3.ubuntu.pool.ntp.org iburst
#pool ntp.ubuntu.com
```

`# service ntp stop`

`# ntpdate 192.168.1.10`



#### VNF部署

#### iptables

` # echo "1"> /proc/sys/net/ipv4/ip_forward`

` # vim /etc/sysctl.conf`

` net.ipv4.ip_forward = 1`

重启虚拟机

```
iptables -A FORWARD -s 192.160.1.11 -j REJECT
iptables -A FORWARD -s 192.168.1.0/24 -j ACCEPT
```





#### Suricata

```
# apt-get install libpcre3 libpcre3-dbg libpcre3-dev build-essential libpcap-dev libnet1-dev libyaml-0-2 libyaml-dev pkg-config zlib1g zlib1g-dev libcap-ng-dev libcap-ng0 make libmagic-dev libjansson-dev libnss3-dev libgeoip-dev liblua5.1-dev libhiredis-dev libevent-dev python-yaml rustc cargo
# apt-get install --reinstall ca-certificates
# add-apt-repository ppa:oisf/suricata-stable
# apt-get update
# apt-get install suricata
```

`# vim /etc/suricata/suricata.yaml`

```
vars:
  address-groups:
    HOME_NET: "[192.168.3.0/24]"
...
default-rule-path: /var/lib/suricata/rules
rule-files:
  - suricata.rules
```

`# suricata-update`

`# suricata -c /etc/suricata/suricata.yaml -i ens192`



#### ntopng

`# apt-get install ntopng`

`# vim /etc/ntopng.conf`

```
# DO NOT REMOVE the following option, required for daemonization.
-e=

# * Interfaces to sniff on: one interface per line, prefix with -i=
# If none is specified, ntopng will try to auto-detect the best interface.

-i=ens192

# * Port on which ntopng will listen for the web-UI.
-w=3000
```

`# vim /etc/ntopng.start`

```
--local-networks "192.168.4.0/24"  ## give your local IP Ranges here.
--interface 1
```

`# systemctl restart ntopng`

登入`http:192.168.4.40:3000`

用户名：admin

密码：admin



#### nDPI

`# apt-get install gcc build-essential autoconf libtool gawk libpcap-dev libjson-c-dev`

`# git clone https://github.com/ntop/nDPI.git`

`# cd nDPI`

`# ./autogen.sh`

`# ./configure`

`# make`

`# make install`

`# ndpiReader -i ens192`



#### HAProxy

`# apt-get install haproxy`

`# vim /etc/haproxy/b.cfg`

```
global
        log /dev/log    local0
        log /dev/log    local1 notice
        chroot /var/lib/haproxy
        stats socket /run/haproxy/admin.sock mode 660 level admin
        stats timeout 30s
        user haproxy
        group haproxy
        daemon

        # Default SSL material locations
        ca-base /etc/ssl/certs
        crt-base /etc/ssl/private

        # Default ciphers to use on SSL-enabled listening sockets.
        # For more information, see ciphers(1SSL). This list is from:
        #  https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/
        ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS
        ssl-default-bind-options no-sslv3

defaults
        log     global
        mode    http
        option  httplog
        option  dontlognull
        timeout connect 5000
        timeout client  50000
        timeout server  50000
        errorfile 400 /etc/haproxy/errors/400.http
        errorfile 403 /etc/haproxy/errors/403.http
        errorfile 408 /etc/haproxy/errors/408.http
        errorfile 500 /etc/haproxy/errors/500.http
        errorfile 502 /etc/haproxy/errors/502.http
        errorfile 503 /etc/haproxy/errors/503.http
        errorfile 504 /etc/haproxy/errors/504.http

listen stats
        bind 192.168.6.60:8080
        server server1 192.168.6.70:80 maxconn 32
        stats  uri /stats
        stats refresh 30s
        stats realm Haproxy Manageer
        stats auth admin:admin
        stats admin if TRUE
```

`# /usr/sbin/haproxy -f /etc/haproxy/b.cfg`

登入`http:192.168.2.50:8080/stats`

用户名：admin

密码：admin



#### Server

`# iptables -t nat -A POSTROUTING -o ens192 -s 192.168.6.0/24 -j SNAT --to 10.112.103.37`

`# apt-get install nginx`

`# nginx -t`

`# vim /var/www/html/index.nginx-debian.html`

修改服务页面







